{% extends 'base.html' %}
{% load permission_tags %}

{% block header %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <style>
        body { font-family: sans-serif; }
        .container { max-width: 1100px; margin: 0 auto; display: flex; gap: 20px; }
        #calendar { flex: 1; }
        .form-section {
            flex: 0 0 300px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            display: none; /* Ocultar o formulário por padrão */
        }
        .form-section h2 { margin-top: 0; }
    </style>
{% endblock header %}

{% load crispy_forms_tags %}


{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">{% include 'includes/mensagens.html' %}</div>
    </div>
</div>

<div class="container">
    <div id="eventos-do-dia" style="display:none; padding:15px; border:1px solid #ccc; margin-top:20px;">
        <h3>Eventos do dia</h3>
        <ul id="lista-eventos"></ul>
    </div>
    <div id="agendamento-form-container" class="form-section">
        <h2>Novo Agendamento</h2>
        <form id="agendamento-form" method="post">
            {% csrf_token %}
            {{ form|crispy }}
            <button type="submit">Guardar Agendamento</button>
        </form>
        <button id="close-form-btn" class="btn btn-secondary mt-2">Fechar</button>
    </div>

    <div id="calendar-container">
        <h1>Meu Calendário de Agendamentos</h1>
        <div id="calendar"></div>
    </div>
</div>

{% endblock content %}


{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var formContainer = document.getElementById('agendamento-form-container');
    var closeFormBtn = document.getElementById('close-form-btn');

    // Usar os IDs dos campos que você definiu no forms.py
    var titleInput = document.getElementById('id_title');
    var startInput = document.getElementById('id_start_time');
    var endInput = document.getElementById('id_end_time');
   

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: true,
        selectable: true,

        // Carregar eventos da API
        events: '/agendamentos_json/', // Mantenha a URL da vista que criamos anteriormente
        
        // Lidar com a criação de novos eventos clicando numa data
        dateClick: function(info) {
        // --- PEGAR EVENTOS DO DIA CLICADO ---
        var clickedDate = info.date; // objeto Date do clique
        var startOfDay = new Date(clickedDate);
        startOfDay.setHours(0,0,0,0);
        var endOfDay = new Date(clickedDate);
        endOfDay.setHours(23,59,59,999);

        // pega todos eventos carregados no calendário
        var allEvents = calendar.getEvents();

        // filtrar os eventos do dia
        var eventsOfDay = allEvents.filter(function(event){
            // pega início e fim do evento
            var evStart = event.start;
            var evEnd = event.end || event.start; // se não tiver fim, usa o início

            return (evStart < endOfDay && evEnd > startOfDay);
        });

        // --- MOSTRAR LISTA ---
        var lista = document.getElementById('lista-eventos');
        lista.innerHTML = ''; // limpar
        if (eventsOfDay.length === 0) {
            lista.innerHTML = '<li>Nenhum evento para este dia</li>';
        } else {
            eventsOfDay.forEach(function(ev){
            var li = document.createElement('li');
            li.textContent = ev.title + ' - ' +
                ev.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) +
                (ev.end? ' às ' + ev.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '');
            lista.appendChild(li);
            });
        }

        document.getElementById('eventos-do-dia').style.display = 'block';

        // --- AINDA PODE ABRIR FORM SE QUISER ---
        formContainer.style.display = 'block';
        document.getElementById("agendamento-form").reset();

        // preencher form com hora padrão para novo agendamento
        var startDate = new Date(info.dateStr + 'T09:00:00'); // 9h
        var endDate   = new Date(info.dateStr + 'T10:00:00'); // 10h
        startInput.value = startDate.toISOString().slice(0,16);
        endInput.value = endDate.toISOString().slice(0,16);
        titleInput.focus();
        },
        eventClick: function(info) {
            // Prevenir o comportamento padrão
            info.jsEvent.preventDefault();

            // Mostrar o formulário
            formContainer.style.display = 'block';

            // Preencher o formulário com os dados do evento
            titleInput.value = info.event.title;
            // O FullCalendar fornece as datas já em formato ISO para preencher o input
            startInput.value = info.event.startStr.slice(0, 16);
            if (info.event.endStr) {
                 endInput.value = info.event.endStr.slice(0, 16);
            } else {
                 // Lógica para eventos sem hora de fim
                 const eventEnd = new Date(info.event.start.getTime() + 60 * 60 * 1000);
                 endInput.value = eventEnd.toISOString().slice(0, 16);
            }
        },
        // As lógicas de update, resize e delete via API estão corretas
        // desde que você tenha os endpoints corretos no Django
        // e que você use a autenticação de CSRF corretamente.
        // O seu código para isso é avançado e parece estar no caminho certo.
        eventDrop: function(info) {
            updateEvent(info.event);
        },
        eventResize: function(info) {
            updateEvent(info.event);
        },
       
    });

    calendar.render();

    // Adicionar funcionalidade para fechar o formulário
    closeFormBtn.addEventListener('click', function() {
        formContainer.style.display = 'none';
    });

    function updateEvent(event) {
        fetch(`/agendamentos_json/${event.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                title: event.title,
                start: event.startStr,
                end: event.endStr
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                alert('Erro ao atualizar agendamento');
            }
        });
    }
});
</script>

{% endblock scripts %}