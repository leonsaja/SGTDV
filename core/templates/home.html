{% extends 'base.html' %}
{% load permission_tags %}
{% block header%}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock header %}
{% load crispy_forms_tags %}
{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">{% include 'includes/mensagens.html'%}</div>
    </div>
    <div class="row mt-4">
        <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-info">
                <div class="inner">
                    <h3>{{qta_recibo_tfd}}</h3>
                    <p>Recibos de TFDs</p>
                </div>
                <div class="icon">
                    <i class="ion ion-bag"></i>
                </div>

            </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-success">
                <div class="inner">
                    <h3>{{qta_viagens}}</h3>

                    <p>Viagens</p>
                </div>
                <div class="icon">
                    <i class="ion ion-stats-bars"></i>
                </div>

            </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3>{{qta_cidadao}}</h3>

                    <p>Cidadãos</p>
                </div>
                <div class="icon">
                    <i class="ion ion-person-add"></i>
                </div>

            </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-danger">
                <div class="inner">
                    <h3>{{qta_diaria}}</h3>

                    <p>Diárias</p>
                </div>
                <div class="icon">
                    <i class="ion ion-pie-graph"></i>
                </div>

            </div>
        </div>
        <!-- ./col -->
    </div>
    <div class="row mt-4">
        <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3>{{qta_registro_transporte}}</h3>
                    <p>Registro de Transportes</p>
                </div>
                <div class="icon">
                    <i class="ion ion-bag"></i>
                </div>

            </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3>{{qta_atendimento}}</h3>

                    <p>Atendimentos de Especialidades</p>
                </div>
                <div class="icon">
                    <i class="ion ion-stats-bars"></i>
                </div>

            </div>
        </div>
        <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-danger">
                <div class="inner">
                    <h3>{{qta_cadastro_incompleto}}</h3>

                    <p>Cadastro incompleto</p>
                </div>
                <div class="icon">
                    <i class="ion ion-stats-bars"></i>
                </div>

            </div>
        </div>
        <!-- ./col -->

    </div>
    {% if user|has_role:'regulacao,recepcao,secretario,coordenador' %}
    <div class="row">
        <div class="col-lg-6">

            <div class="card">
                <div class="card-header border-0">
                    <h3 class="card-title"><b>ESPECIALIDADES</b></h3>
                    <div class="card-tools">
                        <a href="#" class="btn btn-tool btn-sm">
                            <i class="fas fa-download"></i>
                        </a>
                        <a href="#" class="btn btn-tool btn-sm">
                            <i class="fas fa-bars"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-striped table-valign-middle">
                        <thead>
                            <tr>
                                <th>Especialidade</th>
                                <th>Quantidade</th>
                                <th>Eletivo</th>
                                <th>Urgência</th>
                                <th>Prioridade</th>
                                <th>Concluído</th>
                            </tr>
                        </thead>
                        <tbody>

                            {%for especialidade in page_obj %}
                            <tr>
                                <td><a style="text-decoration:none"
                                        href="{% url 'especialidades:detail-especialidade' especialidade.id%}"><b>{{especialidade.nome}}</b></a>
                                </td>
                                <td>{{especialidade.qta_pessoas_especialidade}}</td>
                                <td>{{especialidade.qta_pessoas_eletivo_especialidade}}</td>
                                <td>{{especialidade.qta_pessoas_urgencia_especialidade}}</td>
                                <td>{{especialidade.qta_pessoas_prioridade_especialidade}}</td>
                                <td>{{especialidade.qta_pessoas_concluido_especialidade}}</td>
                            </tr>
                            {%endfor%}
                        </tbody>
                    </table>
                    {% include 'includes/paginacao.html'%}
                </div>
            </div>
            <!-- /.card -->
        </div>
         {% if user|has_role:'digitador,secretario,coordenador' %}
        <div class="col-lg-6">
            <h3 class="text-center"><b>Gastos Mensais das Despesas</b></h3>
            <div style="width: 80%; margin: auto;">
                <canvas id="meuGrafico"></canvas>
            </div>
        </div>
        {%endif%}
    </div>
    {%endif%}
    {% if user|has_role:'regulacao,secretario' %}

    <div class="row mt-4">
        <div class="col-lg-6">
            <h3 class="text-center"><b>Gastos Mensais de TFDs</b></h3>
            <div style="width: 80%; margin: auto;">
                <canvas id="graficoTfd"></canvas>
            </div>
        </div>
    </div>
    {%endif%}


</div>
{{labels|json_script:"labels-data" }}
{{valores_diarias|json_script:"diarias-data" }}
{{valores_reembolsos|json_script:"reembolsos-data" }}
{{labels_tfd|json_script:"labels-tfd-data" }}
{{valores_tfd|json_script:"valores-tfd-data" }}

<script>
    // Acessando os dados do script
    const labels = JSON.parse(document.getElementById("labels-data").textContent);
    const valores_diarias = JSON.parse(document.getElementById("diarias-data").textContent);
    const valores_reembolsos = JSON.parse(document.getElementById("reembolsos-data").textContent);
    const labels_tfd = JSON.parse(document.getElementById("labels-tfd-data").textContent);
    const valores_tfd = JSON.parse(document.getElementById("valores-tfd-data").textContent);

    // --- Gráfico 1: Diárias e Reembolsos ---
    const ctxDiarias = document.getElementById('meuGrafico').getContext('2d');
    new Chart(ctxDiarias, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Gasto com Diárias",
                    data: valores_diarias,
                    backgroundColor: "rgba(54, 162, 235, 0.5)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1,
                },
                {
                    label: "Gasto com Reembolsos",
                    data: valores_reembolsos,
                    backgroundColor: "rgba(255, 99, 132, 0.5)",
                    borderColor: "rgba(255, 99, 132, 1)",
                    borderWidth: 1,
                },
            ],
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: "Mês",
                    },
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Valor (R$)",
                    },
                },
            },
        },
    });

    // --- Gráfico 2: Gasto Total de TFD ---
    const ctxTfd = document.getElementById('graficoTfd').getContext('2d');
    new Chart(ctxTfd, {
        type: 'bar',
        data: {
            labels: labels_tfd,
            datasets: [{
                label: 'Gasto Total TFD',
                data: valores_tfd,
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Mês'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    }
                }
            }
        }
    });

</script>



</div>
{% endblock content %}



{%block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/utils/chart.js"></script>



{% endblock scripts %}